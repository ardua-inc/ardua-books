{% extends "base.html" %}

{% block content %}
  <div class="card">
    <h2>Invoice {{ invoice.invoice_number }}</h2>
    <p class="mb-2">
      <strong>Client:</strong> {{ invoice.client.name }}<br>
      <strong>Issue Date:</strong> {{ invoice.issue_date }}<br>
      <strong>Due Date:</strong> {{ invoice.due_date }}<br>
      <strong>Status:</strong> {{ invoice.get_status_display }}
    </p>

    <h3 class="mt-3">Lines</h3>
    <table class="table">
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
          <th>Qty</th>
          <th>Unit Price</th>
          <th>Line Total</th>
        </tr>
      </thead>
      <tbody>
        {% for line in invoice.lines.all %}
          <tr>
            <td>{{ line.get_line_type_display }}</td>
            <td>{{ line.description }}</td>
            <td>{{ line.quantity }}</td>
            <td>{{ line.unit_price }}</td>
            <td>{{ line.line_total }}</td>
          </tr>
        {% empty %}
          <tr>
            <td colspan="5" class="text-muted">No lines yet.</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>

    <p class="mt-3">
      <strong>Subtotal:</strong> {{ invoice.subtotal }}<br>
      <strong>Tax:</strong> {{ invoice.tax_amount }}<br>
      <strong>Total:</strong> {{ invoice.total }}
    </p>
  </div>

  <h3>Payments Applied</h3>
    <table class="table">
      <tr><th>Date</th><th>Amount</th></tr>
      {% for app in invoice.paymentapplication_set.all %}
      <tr>
        <td>{{ app.payment.date }}</td>
        <td>{{ app.amount }}</td>
      </tr>
      {% empty %}
      <tr><td colspan="2">No payments applied</td></tr>
      {% endfor %}
    </table>

    <p><strong>Outstanding Balance:</strong> {{ invoice.outstanding_balance }}</p>
    <a class="btn btn-primary" href="{% url 'payment_new' %}?client={{ invoice.client.id }}">Apply Payment</a>


  <div class="card">
    <h3 class="mb-3">Add General Line</h3>
    <form method="post" action="{% url 'billing:invoice_add_line' invoice.pk %}">
        {% csrf_token %}
        {{ manual_line_form.as_p }}
        <p class="mt-3">
          <button type="submit" class="btn btn-primary">Add Line</button>
        </p>
      </form>      
  </div>
{% endblock %}
