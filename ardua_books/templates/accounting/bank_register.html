{% extends "base.html" %}
{% block content %}

<h2>Bank Register — {{ bank_account.institution }} ({{ bank_account.account_number_masked }})</h2>

<p>
  <a href="{% url 'accounting:bankaccount_detail' bank_account.id %}" class="btn btn-secondary btn-sm">
    Back to Account
  </a>

  <a href="{% url 'accounting:banktransaction_create' bank_account.id %}" class="btn btn-primary btn-sm">
    New Transaction
  </a>
  <a href="{% url 'accounting:banktransaction_import' bank_account.id %}"
   class="btn btn-warning btn-sm">
   Import CSV
</a>

</p>

<hr>

<!-- Preset Filters -->
<div class="mb-3">
  <a href="?range=last30" class="btn btn-outline-primary btn-sm {% if range_code == 'last30' %}active{% endif %}">Last 30 Days</a>
  <a href="?range=last90" class="btn btn-outline-primary btn-sm {% if range_code == 'last90' %}active{% endif %}">Last 90 Days</a>
  <a href="?range=month" class="btn btn-outline-primary btn-sm {% if range_code == 'month' %}active{% endif %}">Month-to-Date</a>
  <a href="?range=ytd" class="btn btn-outline-primary btn-sm {% if range_code == 'ytd' %}active{% endif %}">Year-to-Date</a>
  <a href="?range=all" class="btn btn-outline-secondary btn-sm {% if range_code == 'all' %}active{% endif %}">All</a>
</div>

<!-- Custom Date Range Filter -->
<form method="get" class="row g-2 mb-4">
  <div class="col-auto">
    <label class="form-label">From:</label>
    <input type="date" name="from" class="form-control" value="{{ from_date|date:'Y-m-d' }}">
  </div>

  <div class="col-auto">
    <label class="form-label">To:</label>
    <input type="date" name="to" class="form-control" value="{{ to_date|date:'Y-m-d' }}">
  </div>

  <div class="col-auto align-self-end">
    <button class="btn btn-primary btn-sm">Apply</button>
  </div>
</form>

<!-- Register Table -->
<table class="table table-striped table-bordered">
  <thead>
    <tr>
      <th>Date</th>
      <th>Description</th>
      <th class="text-end">Withdrawal</th>
      <th class="text-end">Deposit</th>
      <th class="text-end">Balance</th>
      <th>Offset Account</th>
      <th>JE</th>
    </tr>
  </thead>

  <tbody>
    <!-- Balance Forward Row -->
    <tr>
      <td>—</td>
      <td><strong>Balance Forward</strong></td>
      <td></td>
      <td></td>
      <td class="text-end"><strong>{{ balance_forward|floatformat:2|cut:"-" }}</strong></td>
      <td></td>
      <td></td>
    </tr>

    {% for txn in transactions %}
    <tr>
        <td>{{ txn.date }}</td>
        <td>{{ txn.description }}</td>

        {% if txn.amount < 0 %}
        <td class="text-end text-danger">{{ txn.amount|floatformat:2|cut:"-" }}</td>
        <td></td>
        {% else %}
        <td></td>
        <td class="text-end text-success">{{ txn.amount|floatformat:2 }}</td>
        {% endif %}

        <td class="text-end">
        {{ txn.running_balance|floatformat:2 }}
        </td>

        <!-- OFFSET ACCOUNT -->
        <td>
        {% if txn.offset_account %}
            {{ txn.offset_account.code }} — {{ txn.offset_account.name }}
        {% else %}
            —
        {% endif %}
        </td>

        <!-- MATCH / PAYMENT LINKS -->
        <td>
        {% if txn.payment %}
            <a href="{% url 'accounting:payment_detail' txn.payment.id %}">
            Payment #{{ txn.payment.id }}
            </a>
        {% else %}
            <div class="dropdown">
            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" 
                    type="button"
                    data-bs-toggle="dropdown">
                Match
            </button>
            <ul class="dropdown-menu">
                <li>
                <a class="dropdown-item"
                    href="{% url 'accounting:payment_create_from_transaction' txn.id %}">
                    Create Payment…
                </a>
                </li>
                <li>
                <a class="dropdown-item"
                    href="{% url 'accounting:banktransaction_link_payment' txn.id %}">
                    Link Existing Payment…
                </a>
                </li>
                {% if not txn.payment and not txn.expense %}
                <li>
                  <a class="dropdown-item"
                    href="{% url 'accounting:banktransaction_link_expense' txn.id %}">
                    Link Expense…
                  </a>
                </li>
                {% endif %}

                <li><hr class="dropdown-divider"></li>
                <li>
                <a class="dropdown-item text-warning"
                    href="{% url 'accounting:banktransaction_mark_owner_equity' txn.id %}">
                    Mark as Owner Equity
                </a>
                </li>
            </ul>
            </div>
        {% endif %}
        </td>
    </tr>
    {% endfor %}

  </tbody>
</table>

{% endblock %}
