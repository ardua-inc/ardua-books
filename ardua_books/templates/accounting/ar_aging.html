{% extends "base.html" %}
{% load formatting %}

{% block container_class %}container-wide{% endblock %}

{% block content %}
<div class="report-header">
    <div class="report-title-section">
        <h1>Accounts Receivable Aging</h1>
        <p class="report-date-range">As of {{ "now"|date:"M d, Y" }}</p>
    </div>
    <div class="report-actions">
        <a href="{% url 'accounting:home' %}" class="btn btn-secondary btn-sm">Back to Reports</a>
    </div>
</div>

<form method="get" class="report-filters card" id="filterForm">
    <div class="filter-row">
        <div class="filter-group">
            <label for="client">Client</label>
            <select name="client" id="client" class="auto-submit">
                <option value="">All clients</option>
                {% for c in clients %}
                <option value="{{ c.id }}" {% if client_filter == c.id|stringformat:"s" %}selected{% endif %}>{{ c.name }}</option>
                {% endfor %}
            </select>
        </div>
        {% if client_filter %}
        <div class="filter-group filter-actions">
            <label>&nbsp;</label>
            <a href="{% url 'accounting:ar_aging' %}" class="btn btn-secondary btn-sm">Clear Filter</a>
        </div>
        {% endif %}
    </div>
</form>

<div class="aging-summary card">
    <h2>Summary</h2>
    <div class="summary-grid">
        {% for key, bucket in buckets.items %}
        <div class="summary-item {% if bucket.total > 0 %}has-balance{% endif %} {% if key == 'over_90' and bucket.total > 0 %}overdue{% endif %}">
            <div class="summary-label">{{ bucket.label }}</div>
            <div class="summary-amount">${{ bucket.total|floatformat:2 }}</div>
            <div class="summary-count">{{ bucket.invoices|length }} invoice{{ bucket.invoices|length|pluralize }}</div>
        </div>
        {% endfor %}
        <div class="summary-item total">
            <div class="summary-label">Total Outstanding</div>
            <div class="summary-amount">${{ grand_total|floatformat:2 }}</div>
        </div>
    </div>
</div>

{% for key, bucket in buckets.items %}
{% if bucket.invoices %}
<div class="aging-bucket card">
    <div class="bucket-header {% if key == 'over_90' %}overdue-header{% endif %}">
        <h2>{{ bucket.label }}</h2>
        <span class="bucket-total">${{ bucket.total|floatformat:2 }}</span>
    </div>
    <table class="report-table">
        <thead>
            <tr>
                <th class="text-left">Invoice #</th>
                <th class="text-left">Client</th>
                <th class="text-left">Due Date</th>
                <th class="text-right">Days Overdue</th>
                <th class="text-right">Outstanding</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            {% for inv in bucket.invoices %}
            <tr>
                <td class="text-left">
                    <a href="{% url 'billing:invoice_detail' inv.pk %}">{{ inv.invoice_number }}</a>
                </td>
                <td class="text-left">
                    <a href="{% url 'billing:client_detail' inv.client.id %}">{{ inv.client.name }}</a>
                </td>
                <td class="text-left">{{ inv.due_date|date:"m/d/Y" }}</td>
                <td class="text-right {% if inv.age_days > 90 %}text-danger{% elif inv.age_days > 60 %}text-warning{% endif %}">
                    {% if inv.age_days > 0 %}{{ inv.age_days }} days{% else %}Current{% endif %}
                </td>
                <td class="text-right amount">${{ inv.outstanding|floatformat:2 }}</td>
                <td class="text-right">
                    <a href="{% url 'billing:invoice_detail' inv.pk %}" class="btn btn-secondary btn-sm">View</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}
{% endfor %}

{% if grand_total == 0 %}
<div class="card empty-state">
    <p class="text-muted text-center">No outstanding invoices found.</p>
</div>
{% endif %}

<style>
.report-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1.5rem;
}

.report-title-section h1 {
    margin: 0 0 0.25rem 0;
}

.report-date-range {
    margin: 0;
    color: #6b7280;
    font-size: 0.95rem;
}

.report-filters {
    padding: 1rem;
    margin-bottom: 1.5rem;
}

.filter-row {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    align-items: flex-end;
}

.filter-group {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}

.filter-group label {
    font-size: 0.85rem;
    font-weight: 500;
    color: #6b7280;
    margin: 0;
}

.filter-group select {
    padding: 0.4rem 0.6rem;
    border: 1px solid #d1d5db;
    border-radius: 4px;
    font-size: 0.9rem;
    width: 200px;
    height: 34px;
    box-sizing: border-box;
}

.filter-actions .btn {
    height: 34px;
}

.aging-summary {
    padding: 1.25rem;
    margin-bottom: 1.5rem;
}

.aging-summary h2 {
    margin: 0 0 1rem 0;
    font-size: 1rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.03em;
    color: #6b7280;
}

.summary-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 1rem;
}

.summary-item {
    padding: 1rem;
    background: #f9fafb;
    border-radius: 8px;
    text-align: center;
}

.summary-item.has-balance {
    background: #fef3c7;
}

.summary-item.overdue {
    background: #fee2e2;
}

.summary-item.total {
    background: #eff6ff;
    border: 2px solid #3b82f6;
}

.summary-label {
    font-size: 0.85rem;
    color: #6b7280;
    margin-bottom: 0.5rem;
}

.summary-amount {
    font-size: 1.25rem;
    font-weight: 700;
    font-family: monospace;
    color: #111827;
}

.summary-item.overdue .summary-amount {
    color: #991b1b;
}

.summary-item.total .summary-amount {
    color: #1e40af;
}

.summary-count {
    font-size: 0.8rem;
    color: #6b7280;
    margin-top: 0.25rem;
}

.aging-bucket {
    margin-bottom: 1.5rem;
    padding: 0;
    overflow: hidden;
}

.bucket-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 1rem;
    background: #f9fafb;
    border-bottom: 1px solid #e5e7eb;
}

.bucket-header.overdue-header {
    background: #fee2e2;
}

.bucket-header h2 {
    margin: 0;
    font-size: 1rem;
    font-weight: 600;
    color: #374151;
}

.overdue-header h2 {
    color: #991b1b;
}

.bucket-total {
    font-size: 1rem;
    font-weight: 700;
    font-family: monospace;
    color: #374151;
}

.overdue-header .bucket-total {
    color: #991b1b;
}

.report-table {
    width: 100%;
    border-collapse: collapse;
}

.report-table th,
.report-table td {
    padding: 0.75rem 1rem;
    border-bottom: 1px solid #e5e7eb;
}

.report-table thead th {
    background: #fff;
    font-weight: 600;
    font-size: 0.85rem;
    text-transform: uppercase;
    letter-spacing: 0.03em;
    color: #6b7280;
}

.report-table tbody tr:hover {
    background: #f9fafb;
}

.report-table tbody tr:last-child td {
    border-bottom: none;
}

.amount {
    font-family: monospace;
    font-size: 0.95rem;
}

.empty-state {
    padding: 3rem;
}

.text-left { text-align: left; }
.text-right { text-align: right; }
.text-center { text-align: center; }
.text-muted { color: #6b7280; }
.text-danger { color: #dc2626; }
.text-warning { color: #d97706; }

@media (max-width: 768px) {
    .report-header {
        flex-direction: column;
        gap: 1rem;
    }

    .summary-grid {
        grid-template-columns: repeat(2, 1fr);
    }

    .filter-group select {
        width: 100%;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('filterForm');
    const autoSubmitElements = document.querySelectorAll('.auto-submit');

    autoSubmitElements.forEach(function(el) {
        el.addEventListener('change', function() {
            form.submit();
        });
    });
});
</script>

{% endblock %}
