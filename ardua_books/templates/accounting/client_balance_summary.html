{% extends "base.html" %}

{% block container_class %}container-wide{% endblock %}

{% block content %}
<div class="report-header">
    <div class="report-title-section">
        <h1>Client Balance Summary</h1>
        <p class="report-date-range">As of {{ "now"|date:"M d, Y" }}</p>
    </div>
    <div class="report-actions">
        <div class="btn-group">
            <a href="{% url 'accounting:client_balance_print' %}" class="btn btn-outline-secondary btn-sm" target="_blank" title="Print Preview">Print</a>
            <a href="{% url 'accounting:client_balance_pdf' %}" class="btn btn-outline-secondary btn-sm" title="Download PDF">PDF</a>
            <a href="{% url 'accounting:client_balance_csv' %}" class="btn btn-outline-secondary btn-sm" title="Export to CSV">CSV</a>
        </div>
        <a href="{% url 'accounting:home' %}" class="btn btn-secondary btn-sm">Back to Reports</a>
    </div>
</div>

<div class="report-content card">
    <table class="report-table sortable-table">
        <thead>
            <tr>
                <th class="text-left">
                    <a href="?sort=name" class="sort-link {% if sort == 'name' %}active{% endif %}">
                        Client
                        {% if sort == 'name' %}<span class="sort-indicator">&#9650;</span>{% endif %}
                    </a>
                </th>
                <th class="text-right">
                    <a href="?sort=total_invoiced" class="sort-link {% if sort == 'total_invoiced' %}active{% endif %}">
                        Total Invoiced
                        {% if sort == 'total_invoiced' %}<span class="sort-indicator">&#9650;</span>{% endif %}
                    </a>
                </th>
                <th class="text-right">
                    <a href="?sort=applied" class="sort-link {% if sort == 'applied' %}active{% endif %}">
                        Applied Payments
                        {% if sort == 'applied' %}<span class="sort-indicator">&#9650;</span>{% endif %}
                    </a>
                </th>
                <th class="text-right">
                    <a href="?sort=unapplied" class="sort-link {% if sort == 'unapplied' %}active{% endif %}">
                        Unapplied Payments
                        {% if sort == 'unapplied' %}<span class="sort-indicator">&#9650;</span>{% endif %}
                    </a>
                </th>
                <th class="text-right">
                    <a href="?sort=outstanding" class="sort-link {% if sort == 'outstanding' %}active{% endif %}">
                        Outstanding AR
                        {% if sort == 'outstanding' %}<span class="sort-indicator">&#9650;</span>{% endif %}
                    </a>
                </th>
                <th class="text-right">
                    <a href="?sort=net_ar" class="sort-link {% if sort == 'net_ar' %}active{% endif %}">
                        Net Position
                        {% if sort == 'net_ar' %}<span class="sort-indicator">&#9650;</span>{% endif %}
                    </a>
                </th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            {% for row in summary %}
            <tr>
                <td class="text-left">
                    <a href="{% url 'billing:client_detail' row.client.id %}" class="client-name">{{ row.client.name }}</a>
                </td>
                <td class="text-right amount">${{ row.total_invoiced|floatformat:2 }}</td>
                <td class="text-right amount">${{ row.applied|floatformat:2 }}</td>
                <td class="text-right amount {% if row.unapplied > 0 %}has-unapplied{% endif %}">
                    ${{ row.unapplied|floatformat:2 }}
                </td>
                <td class="text-right amount">${{ row.outstanding|floatformat:2 }}</td>
                <td class="text-right amount">
                    {% if row.net_ar > 0 %}
                    <span class="net-position owes">${{ row.net_ar|floatformat:2 }}</span>
                    {% elif row.net_ar < 0 %}
                    <span class="net-position credit">(${{ row.net_ar|floatformat:2|slice:"1:" }})</span>
                    {% else %}
                    <span class="net-position zero">$0.00</span>
                    {% endif %}
                </td>
                <td class="text-right actions">
                    <a href="{% url 'billing:invoice_list' %}?client={{ row.client.id }}" class="btn btn-sm btn-secondary">Invoices</a>
                    <a href="{% url 'accounting:payment_list' %}?client={{ row.client.id }}" class="btn btn-sm btn-secondary">Payments</a>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="7" class="text-center text-muted">No clients found.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<style>
.report-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1.5rem;
}

.report-title-section h1 {
    margin: 0 0 0.25rem 0;
}

.report-date-range {
    margin: 0;
    color: #6b7280;
    font-size: 0.95rem;
}

.report-content {
    padding: 0;
    overflow: hidden;
}

.report-table {
    width: 100%;
    border-collapse: collapse;
}

.report-table th,
.report-table td {
    padding: 0.75rem 1rem;
    border-bottom: 1px solid #e5e7eb;
}

.report-table thead th {
    background: #f9fafb;
    font-weight: 600;
    font-size: 0.85rem;
    text-transform: uppercase;
    letter-spacing: 0.03em;
    color: #6b7280;
}

.report-table tbody tr:hover {
    background: #f9fafb;
}

.sort-link {
    color: #6b7280;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
}

.sort-link:hover {
    color: #3b82f6;
}

.sort-link.active {
    color: #3b82f6;
    font-weight: 700;
}

.sort-indicator {
    font-size: 0.7rem;
}

.client-name {
    font-weight: 500;
    color: #111827;
}

.amount {
    font-family: monospace;
    font-size: 0.95rem;
}

.has-unapplied {
    color: #059669;
    font-weight: 600;
}

.net-position {
    display: inline-block;
    padding: 0.2rem 0.5rem;
    border-radius: 4px;
    font-weight: 600;
}

.net-position.owes {
    background: #fee2e2;
    color: #991b1b;
}

.net-position.credit {
    background: #d1fae5;
    color: #065f46;
}

.net-position.zero {
    background: #f3f4f6;
    color: #6b7280;
}

.actions {
    white-space: nowrap;
}

.actions .btn {
    margin-left: 0.25rem;
}

.text-left { text-align: left; }
.text-right { text-align: right; }
.text-center { text-align: center; }
.text-muted { color: #6b7280; }

@media (max-width: 1024px) {
    .report-header {
        flex-direction: column;
        gap: 1rem;
    }

    .report-table {
        font-size: 0.85rem;
    }

    .report-table th,
    .report-table td {
        padding: 0.5rem 0.75rem;
    }

    .actions .btn {
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
    }
}
</style>

{% endblock %}
